# .github/workflows/ci_packer.yml
name: 1. CI - Build Golden AMI (Packer)

on:
  push:
    branches:
      - main
    paths:
      - 'packer/minecraft.json'

jobs:
  build-ami:
    runs-on: ubuntu-latest
    
    # ИСПРАВЛЕНО: Убедитесь, что имена секретов AWS верны
    env:
      AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
      AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }} # <-- ИСПРАВЛЕНО
      AWS_REGION: ${{ secrets.AWS_REGION }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main

      - name: Run Packer Build
        id: build
        # Выполняем сборку и сохраняем вывод для парсинга
        run: packer build -color=false packer/minecraft.json | tee packer_output.txt

      - name: Extract AMI ID
        id: ami_id
        # Простой парсинг ID AMI
        run: |
          AMI_ID=$(grep 'A new AMI was created' packer_output.txt | awk '{print $NF}')
          echo "ami_id=$AMI_ID" >> $GITHUB_OUTPUT
          
      # Шаг 1. Передача AMI ID через файл (для CD)
      - name: Create AMI ID Artifact
        run: echo "${{ steps.ami_id.outputs.ami_id }}" > ami_id.txt

      - name: Upload AMI ID Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ami-id-artifact
          path: ami_id.txt

      # ➡️ Шаг 2. Запуск следующего пайплайна (CD)
      - name: Trigger CD Deployment
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.GH_DISPATCH_TOKEN }}
          event-type: deploy-infrastructure