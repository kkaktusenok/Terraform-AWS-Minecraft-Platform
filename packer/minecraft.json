{
  "variables": {
    "aws_region": "us-west-1",
    "aws_profile": "dandev"
  },

  "builders": [
    {
      "type": "amazon-ebs",
      "profile": "{{user `aws_profile`}}",
      "region": "{{user `aws_region`}}",
      "instance_type": "t3.medium",
      "ssh_username": "ubuntu",
      "associate_public_ip_address": true,

      "source_ami_filter": {
        "filters": {
          "name": "ubuntu/images/hvm-ssd/ubuntu-focal-20.04-amd64-server-*",
          "root-device-type": "ebs",
          "virtualization-type": "hvm"
        },
        "most_recent": true,
        "owners": "099720109477"
      },

      "ami_name": "minecraft-papermc-1.21.10-117-golden-{{timestamp}}",
      "ami_description": "Ubuntu 20.04 + PaperMC 1.21.10 build 117 + Temurin 21 + systemd (final fixed)",
      "tags": {
        "Name": "Golden-Minecraft-1.21.10-FINAL",
        "Project": "Terraform-AWS-Minecraft"
      }
    }
  ],

  "provisioners": [
    {
      "type": "shell",
      "inline": [
        "echo '=== Обновление системы ==='",
        "sudo apt update -y && sudo apt upgrade -y",

        "echo '=== Установка Temurin 21 JRE (ТРЕБУЕТСЯ ДЛЯ 1.21.10) ==='",
        "sudo apt install -y wget gnupg apt-transport-https ca-certificates",
        "sudo mkdir -p /etc/apt/keyrings",
        "wget -qO - https://packages.adoptium.net/artifactory/api/gpg/key/public | sudo tee /etc/apt/keyrings/adoptium.asc > /dev/null",
        "echo 'deb [signed-by=/etc/apt/keyrings/adoptium.asc] https://packages.adoptium.net/artifactory/deb focal main' | sudo tee /etc/apt/sources.list.d/adoptium.list",
        "sudo apt update -y",
        "sudo apt install -y temurin-21-jre",
        "java -version",

        "echo '=== Создание структуры Minecraft ==='",
        "sudo mkdir -p /minecraft/logs",
        "sudo chown -R ubuntu:ubuntu /minecraft",

        "echo '=== Скачивание PaperMC 1.21.10 build 117 ==='",
        "cd /minecraft",
        "wget -O paper.jar 'https://api.papermc.io/v2/projects/paper/versions/1.21.10/builds/117/downloads/paper-1.21.10-117.jar'",
        "chmod +x paper.jar",

        "echo 'eula=true' > eula.txt",

        "echo '=== server.properties ==='",
        "cat > server.properties <<EOF",
        "server-port=25565",
        "motd=§6Dan4ik §fMinecraft §a1.21.10 §8| §bGolden AMI 2025 (Java 21 Fixed)",
        "max-players=20",
        "online-mode=true",
        "spawn-protection=0",
        "difficulty=normal",
        "gamemode=survival",
        "EOF",

        "echo '=== systemd-сервис ==='",
        "sudo tee /etc/systemd/system/minecraft.service > /dev/null <<EOF",
        "[Unit]",
        "Description=PaperMC 1.21.10 Server",
        "After=network.target",
        "",
        "[Service]",
        "User=ubuntu",
        "WorkingDirectory=/minecraft",
        "ExecStart=/usr/bin/java -Xmx2048M -Xms2048M -jar paper.jar nogui",
        "Restart=always",
        "RestartSec=5",
        "StandardOutput=journal",
        "StandardError=journal",
        "",
        "[Install]",
        "WantedBy=multi-user.target",
        "EOF",

        "sudo systemctl daemon-reload",
        "sudo systemctl enable minecraft.service",

        "echo '=== ГОТОВО! Сервер запустится после boot ==='"
      ]
    }
  ]
}